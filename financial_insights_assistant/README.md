# Financial Insights Assistant - A Multi-Agent System (A2A, MCP, Docker)

This project demonstrates a sophisticated multi-agent system designed for financial analysis and insights. It leverages Agent-to-Agent (A2A) communication principles, integrates with third-party Model Context Protocol (MCP) servers, and is fully containerized using Docker and Docker Compose.

## Architecture Overview

The system is composed of several interconnected services:

**I. Core MCP Servers (External Capabilities):**
1.  **PostgreSQL Database ():**
    *   Stores market data fetched by agents and predictions generated by the Analysis Agent.
    *   Uses the official  Docker image.
    *   Schema is automatically initialized from  on first run.
2.  **PostgreSQL MCP Server ():**
    *   Provides MCP tools to interact with the PostgreSQL database (e.g., execute SQL queries).
    *   Uses the  Docker image.
    *   Configured to connect to our  service.
3.  **Financial Data MCP Server ():**
    *   Provides MCP tools for financial analysis, fetching stock data, technical indicators, etc.
    *   Uses the  project, which leverages the Tiingo API for market data.
    *   **CRITICAL SETUP NOTE:** This service is built from source. You **MUST** manually clone or download the  repository into the  directory before building.
    *   Requires a  environment variable.

**II. Custom A2A Interface Agents (Our Abstraction Layer):**
4.  **PostgreSQL Interface Agent ():**
    *   An A2A-compliant service that acts as a client to our .
    *   Exposes simplified A2A tools (e.g., , ) for other agents to use for database interactions.
    *   Built with FastAPI and Google ADK.
5.  **Financial Data Interface Agent ():**
    *   An A2A-compliant service that acts as a client to our .
    *   Exposes curated A2A tools based on 's capabilities (e.g., ).
    *   Built with FastAPI and Google ADK.

**III. Core Logic & User Interface Agents:**
6.  **Looping Analysis Agent ():**
    *   An A2A-compliant service responsible for continuous analysis of a user-specified stock.
    *   Its analysis loop can be started and stopped via A2A calls from the Host Agent.
    *   In its loop, it:
        1.  Calls the  (A2A) to fetch current market data/analysis for the target stock.
        2.  Calls the  (A2A) to store this fetched data in the PostgreSQL DB.
        3.  Performs a simple/mock prediction based on the data.
        4.  Prints the prediction to its console logs.
        5.  Stores the prediction in the PostgreSQL DB (via ).
    *   Built with FastAPI and Google ADK.
7.  **Host Agent (UI & Orchestration) ():**
    *   The main user-facing component, providing a Gradio web UI for chat interaction.
    *   Contains an ADK Agent powered by a Gemini model to understand user requests.
    *   Orchestrates tasks by making A2A calls to:
        *    (to start/stop the analysis loop).
        *    (to query stored predictions or other data).
        *    (for direct ad-hoc financial data queries, if implemented).
    *   Built with Gradio, FastAPI, and Google ADK.

All custom agents use  as their base Docker image.

## Project Structure
(A brief overview of the main folders - refer to previous plan steps for the full structure if needed for your internal context)
```
financial_insights_assistant/
├── common/                 # Shared (db_schema.sql)
├── config_mcp/             # Configs/source for MCP servers (esp. mcp-trader-src)
├── host_agent/             # Host UI & Orchestrator Agent
├── pg_interface_agent/     # A2A client for postgres-mcp
├── fin_interface_agent/    # A2A client for mcp-trader
├── analysis_loop_agent/    # Looping analysis logic
├── .env.example            # Environment variable template
├── docker-compose.yml      # Docker Compose orchestration
├── requirements.txt        # Python dependencies
└── README.md               # This file
```

## Prerequisites

*   Docker and Docker Compose installed.
*   Git (to clone ).
*   A Tiingo API Key (for ). Get one from [https://www.tiingo.com/](https://www.tiingo.com/).
*   (Optional) A Google Cloud Project and API key if you intend to use a non-free Gemini model or specific Vertex AI features for the Host Agent's ADK setup. The default is .

## Setup Instructions

1.  **Clone this Project:**
    `git clone <your-repo-url> financial_insights_assistant`
    `cd financial_insights_assistant`

2.  **Populate  Source Code:**
    *   **THIS IS A CRITICAL MANUAL STEP.**
    *   Navigate to the directory for  source:
        `cd config_mcp/mcp-trader-src`
    *   Clone the  repository here:
        `git clone https://github.com/wshobson/mcp-trader.git .`
        (The `.` clones it into the current `mcp-trader-src` directory).
    *   Ensure this directory now contains 's files, including its , , etc.
    *   Return to the project root: `cd ../..`

3.  **Configure Environment Variables:**
    *   Copy the example environment file: `cp .env.example .env`
    *   Edit the `.env` file with your actual credentials and any desired changes:
        *   `TIINGO_API_KEY`: Your Tiingo API key. **Required for **.
        *   `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`: Credentials for the PostgreSQL database. The defaults are usually fine for local demo.
        *   `ANALYSIS_LOOP_SLEEP_INTERVAL_SECONDS`: How often the analysis loop runs (default 60s).
        *   (Optional) `HOST_AGENT_MODEL`, `GOOGLE_API_KEY`, `ADK_PROJECT_ID`, `ADK_LOCATION`: If you need to customize the Gemini model or ADK settings for the Host Agent.

4.  **Review Docker Base Image:**
    *   Our custom agents use `orchestranexus/agentbox:0.0.0`. If this image is unavailable, you'll need to change the `FROM` line in the Dockerfiles within `host_agent/`, `pg_interface_agent/`, `fin_interface_agent/`, and `analysis_loop_agent/` to a suitable Python 3.10+ image and ensure system dependencies (like build tools for `psycopg2-binary` if needed, though usually handled by wheels) are met.
    *   The `mcp-trader` service builds using the Dockerfile from its own repository. This Dockerfile **must** handle the installation of the `ta-lib` C library, which is a common dependency for financial Python packages. If its build fails due to `ta-lib`, you may need to troubleshoot its Dockerfile or the base image it uses.

## Running the Application

1.  **Build and Start Services:**
    *   From the project root (`financial_insights_assistant/`), run:
        ```bash
        docker-compose up --build -d
        ```
        *   `--build`: Builds the images for the first time or if code/Dockerfiles change.
        *   `-d`: Runs in detached mode (in the background).
    *   This will:
        *   Download official images (PostgreSQL, postgres-mcp).
        *   Build the `mcp-trader` image from `config_mcp/mcp-trader-src/`.
        *   Build images for all our custom A2A agents.
        *   Start all 7 services.
        *   Initialize the PostgreSQL database schema on its first startup.

2.  **Check Service Logs (Optional):**
    *   You can view logs for all services: `docker-compose logs -f`
    *   Or for a specific service: `docker-compose logs -f host_agent_ui_container`

3.  **Access the User Interface:**
    *   Once all services are up and running (especially `host_agent_ui_container`), open your web browser to:
        `http://localhost:8080`

## Example Interactions with the UI

*   "Please start analyzing stock NVDA."
*   "What is the current analysis status?"
*   "Show me the latest prediction for NVDA."
*   "Stop the analysis loop."
*   (If Host Agent supports it) "Get me the technical analysis for GOOGL."
*   (If Host Agent supports it) "Show me the last 3 predictions stored for NVDA using SQL."

## Stopping the Application

*   To stop all running services:
    ```bash
    docker-compose down
    ```
*   If you also want to remove the PostgreSQL data volume (all stored data will be lost):
    ```bash
    docker-compose down -v
    ```

## Troubleshooting / Development Notes
*   **`mcp-trader` Build:** The most likely point of failure during the first build is the `mcp-trader_server` if its source code is missing from `config_mcp/mcp-trader-src/` or if its Dockerfile has issues (especially with `ta-lib`).
*   **Service URLs:** Inter-agent communication uses Docker DNS service names (e.g., `http://pg_interface_agent_container:8001`). These are configured in `docker-compose.yml` and passed as environment variables to the agents that need them.
*   **A2A Message Structure:** Our agents use a basic A2A message structure where tool calls are in `message.parts[0].tool_code` and results in `message.parts[0].tool_data`. This can be extended if more complex multi-part messages are needed.
